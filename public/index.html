<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WhatsApp Bot Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #0f172a; color: #e2e8f0; }
    .card { background: #111827; border: 1px solid #1f2937; }
    .btn-primary { background: #2563eb; border: none; }
    .status-dot { width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px; }
    .dot-ok { background:#10b981; } .dot-bad { background:#ef4444; } .dot-warn{ background:#f59e0b; }
    #qr { max-width: 320px; border:8px solid #1f2937; border-radius:12px; }
    .muted { color:#94a3b8; }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="h3 m-0">WhatsApp Bot <span class="muted">/ Dashboard</span></h1>
      <div>
        <span id="status-dot" class="status-dot dot-bad"></span>
        <span id="status-text">Desconectado</span>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-lg-6">
        <div class="card p-4 h-100">
          <h2 class="h5 mb-3">Vincular (escanea el QR)</h2>
          <p class="muted">Abre WhatsApp → Dispositivos vinculados → Vincular dispositivo, y escanea este QR.</p>
          <div class="text-center">
            <img id="qr" alt="QR" src="" class="d-none" />
            <div id="no-qr" class="muted">No hay QR disponible (¿ya estás conectado?).</div>
          </div>
          <div class="mt-3 d-flex gap-2 justify-content-center">
            <button id="refresh" class="btn btn-outline-light btn-sm">Refrescar</button>
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card p-4 h-100">
          <h2 class="h5 mb-3">Sesión</h2>
          <ul class="list-group list-group-flush">
            <li class="list-group-item bg-transparent text-light">
              <strong>Estado:</strong> <span id="state">—</span>
            </li>
            <li class="list-group-item bg-transparent text-light">
              <strong>Dispositivo:</strong> <span id="device">—</span>
            </li>
            <li class="list-group-item bg-transparent text-light">
              <strong>Proveedor IA:</strong> <span id="provider">—</span>
            </li>
          </ul>
          <div class="mt-3">
            <button id="logout" class="btn btn-danger">Desvincular (logout)</button>
          </div>
        </div>
      </div>
    </div>

    <footer class="mt-5 text-center muted">Semilla Proyectos · Baileys + Dashboard</footer>
  </div>

  <script>
    async function fetchStatus() {
      const res = await fetch('/api/status')
      const data = await res.json()
      document.getElementById('provider').textContent = data.aiProvider || '—'
      document.getElementById('device').textContent = data.device || '—'
      document.getElementById('state').textContent = data.connected ? 'Conectado' : (data.qr ? 'Esperando vínculo' : 'Desconectado')
      document.getElementById('status-text').textContent = data.connected ? 'Conectado' : (data.qr ? 'Esperando vínculo' : 'Desconectado')
      document.getElementById('status-dot').className = 'status-dot ' + (data.connected ? 'dot-ok' : data.qr ? 'dot-warn' : 'dot-bad')
      const qrImg = document.getElementById('qr')
      const noQr = document.getElementById('no-qr')
      if (data.qr) {
        qrImg.src = '/api/qr?ts=' + Date.now()
        qrImg.classList.remove('d-none')
        noQr.classList.add('d-none')
      } else {
        qrImg.classList.add('d-none')
        noQr.classList.remove('d-none')
      }
    }

    document.getElementById('refresh').addEventListener('click', fetchStatus)
    document.getElementById('logout').addEventListener('click', async () => {
      if (!confirm('¿Seguro que deseas cerrar la sesión de WhatsApp?')) return
      const res = await fetch('/api/logout', { method: 'POST' })
      const data = await res.json().catch(() => ({}))
      alert(data.message || 'Logout solicitado. Revisa los logs.')
      fetchStatus()
    })

    fetchStatus()
    setInterval(fetchStatus, 4000)
  </script>
</body>
</html>
